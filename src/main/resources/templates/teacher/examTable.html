<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>试卷管理</title>
    <link rel="stylesheet" th:href="@{/layuires/layui/css/layui.css}">
    <script th:src="@{/layuires/layui/layui.js}"></script>
    <script th:src="@{/js/jquery-3.4.1.js}"></script>
</head>
<body>

<div class="demoTable">
    科目:<select  lay-verify="required" id="type">
</select>
    <button class="layui-btn" data-type="reload" id="cha">查询</button>
    <input type="button" id="add" class="layui-btn" value="新增试卷">
</div>


<table id="demo" lay-filter="test"></table>

<script type="text/html" id="bar">
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="remove">删除</a>
</script>

<script>

	$(function ()
	{
		$.ajax({
			type:"POST",
			url:"/eq/getSubs",
			success:function(msg)
			{
				document.getElementById("type").length=0;
				$('#type').append("<option value='所有'>所有</option>");
				for(var i=0;i<msg.length;i++)
				{
					$('#type').append("<option value='"+msg[i].sid+"'>"+msg[i].sname+"</option>")
				}
			},
			error:function ()
			{
				layer.alert("服务器正忙.....", {icon: 5});
			}
		});
	});

	layui.use('table', function()
	{
		var table=layui.table;
		table.render({
			elem: '#demo'
			,url: "/eq/getList"
			,page: true
			,limit:5
			,limits:[5]
			,id:"testReload"
			,cols: [
				[
					{field: 'ename', title: '试卷名', width:80}
                    ,{field: 'tips', title: '学科', width:80}
                    ,{field: 'estart', title: '开始时间', width:150}
                    ,{field: 'eend', title: '截止时间', width:150}
                    ,{field: 'ecode', title: '考试码', width:100}
                    ,{field: 'eduration', title: '考试时长(小时)', width:130}
					, {title: '操作', width: 80, toolbar: '#bar'}
				]
			]
		});

		$('#cha').click(function ()
        {
	        table.reload('testReload',
		        {
			        page:
				        {
					        curr: 1
				        }
			        , where:
				        {
					        sub: $("#type").val()

				        }
		        });
		});

		table.on('tool(test)', function (obj) {
			var data = obj.data; //获得当前行数据
			var layEvent = obj.event;
			var tr = obj.tr;
			layer.confirm('确定要删除该试卷吗？', function (index) {
                $.ajax({
                    type: "POST",
                    url: "/eq/checkExam",
                    dataType: "text",
                    data: {eid:data.eid},
                    success: function (msg) {
                        if (msg === "yes")
                        {

	                        $.ajax({
		                        type:'POST',
		                        url:'/eq/deleteExam',
		                        data: {eid:data.eid},
		                        success:function(msg)
		                        {
                                    if(msg==="yes")
                                    {
	                                    layer.open({
		                                    title: ['温馨提示'],
		                                    content: '删除成功',
		                                    btn: ['确定'],
		                                    closeBtn: 0,
		                                    yes: function () {
			                                    $(".layui-laypage-btn")[0].click();
			                                    layer.close(index);
		                                    }
	                                    });
                                    }
                                    else
                                    {
	                                    layer.alert("删除失败，请重试", {icon: 5});
                                    }
		                        },
		                        error:function ()
		                        {
			                        layer.alert("服务器正忙.....", {icon: 5});
		                        }
	                        });
                        } else
                        	{
                            layer.alert("该试卷已有学生答题，无法删除", {icon: 5});
                        }
                    },
                    error: function () {
                        layer.alert("服务器正忙.....", {icon: 5});
                    }
                });
			});
		});
	});

	$('#add').click(function()
	{
		layer.prompt({title:'请输入课程名称'},function(value, index, elem)
		{
			if(value.length>10)
			{
				layer.alert("课程名不得超过10字", {icon: 5});
			}
			else
			{
				$.ajax({
					type:"POST",
					url:"/subject/checkSubject",
					dataType:"text",
					data:{sname:value},
					success:function(msg)
					{
						if(msg==="yes")
						{
							$.ajax({
								type:"POST",
								url:"/subject/addSubject",
								dataType:"text",
								data:{sname:value},
								success:function(msg)
								{
									if(msg==="yes")
									{
										layer.open({
											title: ['温馨提示'],
											content: '新增成功',
											btn: ['确定'],
											closeBtn :0,
											yes: function(){
												window.location.href="/subject/toSubject";
											}
										});
									}
									else
									{
										layer.alert("新增失败，请重试", {icon: 5});
									}
								},
								error:function ()
								{
									layer.alert("服务器正忙.....", {icon: 5});
								}
							});
						}
						else
						{
							layer.alert("该课程已存在", {icon: 5});
						}
					},
					error:function ()
					{
						layer.alert("服务器正忙.....", {icon: 5});
					}
				});
			}
		});
	});

</script>

</body>
</html>